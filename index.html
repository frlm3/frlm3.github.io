<!doctype html>
<html class="no-js" lang="">
<head>
	<meta charset="utf-8">
	<title>Faria Limer Game</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<script src="d3.v7.min.js"></script>
	<script src="norminv.js"></script>
	<link rel="stylesheet" href="style.css" />  
</head>
<body>
<div id="main">
	
	<div id="ajuda" class="titulo laranja">FRLM3 Equity DES</div><div class="vermelho">&nbsp;</div>
	<div>
		<p>Regras do jogo:<br>
			<ul>
				<li>Você começa com R$ 100.000,00 <i>fictícios</i> para operar uma ação <i>simulada</i></li>
				<li>Você pode operar comprado ou vendido</li>
				<li>Faça o maior resultado que conseguir em 60 dias</li>
				<li>Lembre-se que isto é apenas um JOGO, onde tudo é simulado, fictício, de mentira</li>
				<li>Ganhe bastante dinheiro <i>(de mentira)</i> e suba de cargo <i>(também de mentira)</i></li>
			</ul>
			Cargos:
			<ul>
				<li><b>Estagiário</b>: Suas atribuições serão bater as operações boletadas pelos pontas-de-mesa e buscar na padoca o pingado com chapado viajante para os Traders.</li>
				<label for="file">Operações boletadas:</label> <progress id="p_estag" value="0" max="100"></progress>
				<li><b>Ponta-de-mesa</b>: Responsável por boletar as operações dos Traders, e mandar o Estagiário bater as boletas. Seu sonho é virar um Trader.</li>
				<li><b>Trader Jr.</b>: É como se fosse um estagiário, mas um erro seu já custa dinheiro. Não fica mais com cara de perdida quando alguém diz que ficou tomado em bola 45 e dado em faca 26.</li>
			</ul>
		</p>
	</div>

	<div id="titulo" class="titulo laranja">FRLM3 Equity Game</div><div class="vermelho">&nbsp;</div>
	<table id="info_mercado">
		<tr>
			<th width="25%">Cargo</th>
			<th width="25%">Pregão</th>
			<th width="25%">Dia</th>
			<th width="25%">Preço</th>
		</tr>
		<tr>
			<td><span id="cargo">???</span></td>
			<td><span id="state">Não iniciado</span></td>
			<td><span id="tick">0</span>/60</td>
			<td><span id="preco">100,00</span></td>
		</tr>
	</table>
	<table id="hdgrafico">
		<tr><th style="text-align:left;">Analysis Chart</th></tr>
		<tr><td><div id="grafico"></div></td></tr>
	</table>
	
	<div id="operacoes">
		<button id="iniciar" onClick="iniciar_jogo();">1) Iniciar</button>
		<button id="comprar" onClick="comprar();" disabled="disabled">Comprar</button>
		<button id="vender"  onClick="vender();" disabled="disabled">Vender</button>
	</div>	
	<table id="info_posicao">
		<tr>
			<th width="40%">Saldo</th>
			<th width="30%">Posição</th>
			<th width="30%">PnL</th>
		</tr>
		<tr>
			<td><span id="cash">100.000,00</span></td>
			<td><span id="posicao">0</span></td>
			<td><span id="pnl">0,00</span>
		</tr>
	</table>
	
	<!--
	<div id="noticias" class="titulo laranja">TRDG3 Equity CN</div><div class="vermelho">&nbsp;</div>
	<div id="news">blabla</div>
	-->

</div>
<script>
var n = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2, }),
	q = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0, });

var refreshIntervalId,
	tick = -1,
	precos = [100],
	cash = 100000,
	posicao = 0,
	pnl = 0,
	rodadas = 60,
	direcao = 0,
	mercado = dir_mercado(Math.random()),
	cargos = ['Estagiário','Ponta-de-mesa','Trader Jr.'];

if(!localStorage.getItem('cargo')) {
	iniciaStorage();
} else {
	calculaCargo();
}

function iniciaStorage() {
	localStorage.setItem('cargo', 0);
	localStorage.setItem('operacoes', 0);
	localStorage.setItem('dias_ponta', 0);
	localStorage.setItem('dias_total', 0);
	calculaCargo();
}
function calculaCargo(){
	var cargo_atual = parseInt(localStorage.getItem('cargo'));

	switch (true) {
		case cargo_atual == 0: // Estagiário
			if(parseInt(localStorage.getItem('operacoes')) > 99){
				cargo_atual = 1;
			}
			break;
	}

	localStorage.setItem('cargo', cargo_atual);
	out(cargos[cargo_atual], 'cargo');
}


function iniciar_jogo(){

	out("Em andamento", "state");

	if(parseInt(localStorage.getItem('cargo')) == 1){
		incrementa_storage('dias_ponta');
	}
	incrementa_storage('dias_total');
	tick = -1;
	precos = [100];
	cash = 100000;
	posicao = 0;
	pnl = 0;
	direcao = 0;
	mercado = dir_mercado(Math.random());
	console.log(mercado);

	document.getElementById("iniciar").disabled = true;
	document.getElementById("comprar").disabled = false;
	document.getElementById("vender").disabled = false;

	atualiza_posicao();
	refreshIntervalId = setInterval(atualiza_posicao, 1000);
		
}

function atualiza_posicao(){

	monta_grafico();

	tick++;
	if(tick == rodadas) { finalizar_jogo(); }
	
	var rnd = Math.random();
	var variacao = normsInv(rnd, mercado, 0.075);
	var vchoque = choque(Math.random());
	var novo_preco = (1+variacao)*precos[tick]*vchoque;
	precos.push(novo_preco);
	pnl = posicao * precos[tick] + cash - 100000;

	if(pnl < -100000) { stop_loss(); }
	atualiza_tela();
	
}

function stop_loss(){
	alert("Seu stop loss foi acionado! Cuidados com as posições vendidas...");
	localStorage.setItem('cargo', 0);
	localStorage.setItem('operacoes', 0);
	localStorage.setItem('dias_ponta', 0);
	localStorage.setItem('dias_total', 0);
	finalizar_jogo();
}

function atualiza_tela(){

	document.getElementById("p_estag").value = localStorage.getItem('operacoes');
	out(tick, 'tick');
	out(n.format(precos[tick]), "preco");
	out(n.format(cash), "cash");
	out(q.format(posicao), "posicao");
	out(n.format(pnl), "pnl");

}

function incrementa_storage(chave){
	localStorage.setItem(chave, parseInt(localStorage.getItem(chave))+1);
}
	
function comprar(){

	switch (true) {
		case posicao == 0:
			posicao = cash/precos[tick];
			cash = 0;
			incrementa_storage('operacoes');
			break;
		
		case posicao > 0:
			break;
		
		case posicao < 0:
			cash -= (-posicao*precos[tick]);
			posicao = 0;
			incrementa_storage('operacoes');
			break;
	}
	atualiza_tela();
}
function vender(){

	switch (true) {
		case posicao == 0:
			posicao = -cash/precos[tick];
			cash *= 2;
			incrementa_storage('operacoes');
			break;
		
		case posicao > 0:
			cash = posicao*precos[tick];
			posicao = 0;
			incrementa_storage('operacoes');
			break;
		
		case posicao < 0:
			break;
	}
	atualiza_tela();
}

function finalizar_jogo() {
	
	calculaCargo();
	monta_grafico();
	atualiza_tela();
	clearInterval(refreshIntervalId);
	out("Encerrado", "state");
	document.getElementById("iniciar").disabled = false;
	document.getElementById("comprar").disabled = true;
	document.getElementById("vender").disabled = true;
	
}

function dir_mercado(prob){
	
		if(prob < 0.1) 	return -0.015;
   else if(prob < 0.9) 	return  0.020;
   else					return  0.035;
	
}

function choque(prob){
	
  		 if(prob < 0.01) return 0.7500;
	else if(prob < 0.99) return 1.0000;
	else				 return 1.3333;

}

function out(valor, id){
	document.getElementById(id).innerHTML = valor;
}

Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}

	
	
function monta_grafico(){
	
	document.getElementById("grafico").innerHTML = "";

	var data = [];
	
	for (let i = 0; i <= rodadas; i++) {
		var date = new Date();
		var ponto = {};
		dia = date.addDays(i);
		ponto.date = dia;
		ponto.close = precos[i];
		data.push(ponto);
	} 

	// set the dimensions and margins of the graph
	var margin = {top: 10, right: 10, bottom: 30, left: 40},
		width = document.getElementById("grafico").clientWidth - margin.left - margin.right,
		height = document.getElementById("grafico").clientHeight - margin.top - margin.bottom;

	// parse the date / time
	var parseTime = d3.timeParse("%Y-%m-%d");

	// set the ranges
	var x = d3.scaleTime().range([0, width]);
	var y = d3.scaleLinear().range([height, 0]);

	// define the line
	var valueline = d3.line()
		.x(function(d) { return x(d.date); })
		.y(function(d) { return y(d.close); });

	var svg = d3.select("#grafico").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
	  .append("g")
		.attr("transform",
			  "translate(" + margin.left + "," + margin.top + ")");

	  // Scale the range of the data
	  x.domain(d3.extent(data, function(d) { return d.date; }));
	  //y.domain([0, d3.max(data, function(d) { return d.close; })]);//.nice();
		y.domain([0, d3.max(data, function(d) { return d.close > 200 ? d.close : 200; })]).nice();
		
	  // Add the valueline path.
	  svg.append("path")
		  .data([data])
		  .attr("class", "line")
		  .attr("d", valueline);



	  // Add the Y Axis
	  svg.append("g")
		  .attr("class", "axis")
		  .call(d3.axisLeft(y));
	
// gridlines in y axis function
function make_y_gridlines() { return d3.axisLeft(y).ticks(); }
	
  // add the Y gridlines
  svg.append("g")			
      .attr("class", "grid")
      .call(make_y_gridlines()
          .tickSize(-width)
          .tickFormat("")
      )
		.style("stroke-dasharray", ("3, 3"))
		.lower();;
	
		  // Add the X Axis
	  svg.append("g")
		  .attr("class", "axis")
		  .attr("transform", "translate(0," + height + ")")
		  .call(d3.axisBottom(x)
				  .tickFormat(d3.timeFormat("%d/%m")))
		  .selectAll("text")	
			.style("text-anchor", "center")
			.attr("dx", "0em")
			.attr("dy", "1em");
	
	svg.append("rect")
	.attr("x", 0)
	.attr("y", 0)
	.attr("width", width)
	.attr("height", height)
	.style("fill", "#6E6E6E50")
	.lower();

}
</script>

<a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Ffrlm3.github.io&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=traders&edge_flat=false"/></a>
</body>
</html>
